
@{
  ViewData["Title"] = "Accounts";
}

<h2>Accounts</h2>
<table id="accountTable" class="table table-striped table-bordered table-hover"></table>

@section Head {
  <link rel="stylesheet" type="text/css" href="~/lib/datatables/datatables.min.css" />
  <style type="text/css">
    .dt-body-center {
      text-align: center;
    }

    .dt-nowrap {
      white-space: nowrap
    }
  </style>
}
@section Scripts {
  <script type="text/javascript" src="~/lib/datatables/datatables.min.js"></script>
  <script type="text/javascript" src="~/lib/moment.min.js"></script>
  <script type="text/javascript" src="~/lib/moment-timezone-with-data.min.js"></script>
  <script>
    (function () {
      var table = $('#accountTable').DataTable({
        serverSide: true,
        select: true,
        ajax: function (data, callback, settings) {
          console.log('table data', data)
          url = '/admin/api/accounts?page[number]=' + Math.floor(1 + data.start / data.length) + '&page[size]=' + data.length;
          if (data.search.value) {
            url = url + '&filter=' + encodeURIComponent(data.search.value)
          }
          if (data.order && data.order.length) {
            url = url + '&sort=' + encodeURIComponent(data.order.map(function (s) { return (s.dir === "desc" ? '-' : '') + data.columns[s.column].data.replace('attributes.', '') }).join());
          }
          $.getJSON(url)
            .success(function (msg) {
              callback({
                draw: data.draw,
                data: msg.data,
                recordsTotal: msg.meta.totalRows,
                recordsFiltered: msg.meta.filteredRows
              })
            })
        },
        columns: [
          { title: 'Name', data: 'attributes.name', className: 'dt-nowrap' },
          { title: 'Last Name', data: 'attributes.lastName' },
          { title: 'Email', data: 'attributes.email' },
          { title: 'User Name', data: 'attributes.userName', render: function (data) { return data === '@("@")' ? '<i>External Login</i>' : data; } },
          { title: 'Locked?', data: 'attributes.isLocked', className: 'dt-body-center', render: function (data) { return data ? '<i class="fa fa-lock"></i>' : '' } },
          { title: 'Last Login', data: 'attributes.lastLogin', render: function (data) { return data ? moment(data).tz("America/Los_Angeles").calendar() : '<i>Never</i>' } }
        ]
      });

      $('#accountTable').on('select.dt', function (e, dt, type, idxs) {
        if (type !== 'row') return
        console.log('Selected row ' + idxs[0] + ', ', table.rows(idxs).data()[0].attributes.email)
      })

      //$.getJSON("/admin/api/accounts?page[number]=1", {})
      //  .done(function (response) {
      //    var data = response.data;
      //    console.log(data);
      //  }
      //).fail(function (err) {
      //  alert('Failed to load accounts');
      //})
      @*function appendSecret(row) {
        $('#secretsTable tbody').append($('<tr/>').append(
          $('<td/>').text(row.description),
          $('<td/>').text(moment(row.created).format('lll'))
        ))
      }

      $.getJSON("/admin/api/clients/@ViewBag.Id", {})
        .done(function (data) {
          data = data.data;
          console.log(data);
          $('#name').text(data.clientName);
          $('#clientId').text(data.clientId);
          data.redirectUris.forEach(function (row) {
            $('#redirectsTable tbody').append($('<tr/>').append(
              $('<td/>').text(row.redirectUri)
            ))
          })
          data.secrets.forEach(function (row) {
            appendSecret(row);
          })
        });

      $('#secretForm').submit(function (e) {
        e.preventDefault();
        $.ajax({
          type: "POST",
          url: "/admin/api/clients/@ViewBag.Id/secrets",
          data: JSON.stringify($(this).serializeArray().reduce(function (obj, cur) { obj[cur.name] = cur.value; return obj }, {})),
          contentType: 'application/json',
          dataType: 'json',
          success: function (data) {
            $('#secretForm').trigger("reset");
            appendSecret(data.data);
          }
        });
      })*@
    })();
  </script>
}